@page
@model Vask_En_Tid.Pages.CreateBookingModel

@if (TempData["Msg"] is string m)
{
    <div class="alert alert-info">@m</div>
}

<form method="post">
    <div asp-validation-summary="ModelOnly" class="text-danger mb-2"></div>

    <div class="row g-2">
        <div class="col-md-4">
            <label class="form-label">Maskine</label>
            <select asp-for="NewBooking.MachineType" class="form-select">
                @foreach (var t in Model.MachineTypes)
                {
                    <option value="@t">@t</option>
                }
            </select>
            <span asp-validation-for="NewBooking.MachineType" class="text-danger"></span>
        </div>

        <div class="col-md-3">
            <label asp-for="NewBooking.BookingDate" class="form-label"></label>
            <input asp-for="NewBooking.BookingDate" type="date" class="form-control" />
            <span asp-validation-for="NewBooking.BookingDate" class="text-danger"></span>
        </div>

        <div class="col-md-3">
            <label asp-for="NewBooking.BookingTime" class="form-label"></label>
            <input asp-for="NewBooking.BookingTime" type="time" class="form-control" step="3600" />
            <span asp-validation-for="NewBooking.BookingTime" class="text-danger"></span>
        </div>
    </div>

    <!-- Repo sætter IsBooked=1 ved succes; behold skjult -->
    <input type="hidden" asp-for="NewBooking.IsBooked" />

    <div class="mt-3 d-flex gap-2">
        <button type="submit" asp-page-handler="Refresh" class="btn btn-outline-secondary">
            Opdatér status
        </button>
        <button type="submit" class="btn btn-primary">
            Book
        </button>
    </div>
</form>

@if (Model.AvailabilityByType?.Any() == true)
{
    <div class="mt-4">
        <h5>Status for valgt tidspunkt</h5>
        <table class="table table-sm align-middle w-auto">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Ledige</th>
                    <th>Booket</th>
                    <th>Kapacitet</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var t in Model.MachineTypes)
                {
                    var a = Model.AvailabilityByType[t];
                    var okClass = a.IsAvailable ? "bg-success" : "bg-danger";
                    var okText = a.IsAvailable ? "Ledig" : "Fuldt booket";
                    <tr>
                        <td>@t</td>
                        <td><strong>@a.Free</strong></td>
                        <td>@a.Used</td>
                        <td>@a.Max</td>
                        <td><span class="badge @okClass">@okText</span></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<hr />

<h5>Eksisterende bookinger</h5>
<table class="table table-striped">
    <thead>
        <tr>
            <th>Id</th>
            <th>Type</th>
            <th>Dato</th>
            <th>Tid</th>
            <th>Booked?</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var a in (Model.Bookings ?? Enumerable.Empty<Vask_En_Tid_Library.Models.Booking>()))
        {
            <tr>
                <td>@a.BookingId</td>
                <td>@a.MachineType</td>
                <td>@a.BookingDate.ToString("yyyy-MM-dd")</td>
                <td>@a.BookingTime.ToString(@"hh\:mm")</td>
                <td>@(a.IsBooked ? "Ja" : "Nej")</td>
                <td>
                    <form method="post" asp-page-handler="Delete" class="d-inline">
                        <input type="hidden" name="bookingId" value="@a.BookingId" />
                        <button type="submit" class="btn btn-sm btn-danger"
                                onclick="return confirm('Slet booking @a.BookingDate @a.BookingTime (@a.MachineType)?');">
                            Slet
                        </button>
                    </form>
                </td>
            </tr>
        }
    </tbody>
</table>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
